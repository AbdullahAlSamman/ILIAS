<script type="text/javascript" id="pers-chat-settings-js">
	(function ($, root) {
		const templates = {
			modal: '<div class="help-block alert alert-danger"><img src="{ALERT_IMAGE_SRC}" /><span></span></div>'
		};

		let emptyErrorMessages = function emptyErrorMessages($parent) {
			$parent.find(".dynamic-errors").remove();
		};

		/**
		 *
		 * @param $parent
		 * @param {string} languageVariable
		 */
		let showErrorMessage = function showErrorMessage($parent, languageVariable) {
			let $warning = $(templates.modal);

			$warning.addClass("dynamic-errors");
			emptyErrorMessages($parent);
			$parent.append($warning);
			$warning.find("span").html(il.Language.txt(languageVariable));
		};

		let deselectAndLockCheckbox = function deselectAndLockCheckbox($elm) {
			$elm.prop("disabled", true);
			$elm.prop("checked", false);
        } ;

		il.Util.addOnLoad(function () {
			// Nesting the addOnLoad code is required because otherwise we cannot use il.Language.txt
			il.Util.addOnLoad(function () {
				let $form = $("#pers-chat-settings-js").parent().find("form:first"),
					$checkboxes = $form.find('input[type="checkbox"]'),
					$notificationToggle = null;

				// Very fucked up!!!
				if (3 === $checkboxes.size()) {
					$notificationToggle = $checkboxes.eq(1);
				} else if (2 === $checkboxes.size()) {
					if ($.contains($checkboxes.eq(0).parent().get(0), $checkboxes.eq(1).get(0))) {
						$notificationToggle = $checkboxes.eq(1);
					}
				}

				if (null !== $notificationToggle) {
					let $container = $notificationToggle.parent();

					if (!il.BrowserNotifications.isSupported()) {
						showErrorMessage($container, 'osc_browser_noti_no_support_error');
						deselectAndLockCheckbox($notificationToggle);
					} else {
						root.setInterval(() => {
							if (il.BrowserNotifications.isBlocked()) {
								showErrorMessage($container, 'osc_browser_noti_no_permission_error');
								deselectAndLockCheckbox($notificationToggle);
							} else {
								$notificationToggle.prop("disabled", false);
								emptyErrorMessages($container);
							}
						}, 1000);
					}

					$notificationToggle.on("change", function () {
						let $elm = $(this),
							currentValue = $elm.is(":checked");

						if (currentValue) {
							il.BrowserNotifications.requestPermission().then(() => {
								$elm.prop("disabled", false);
							}).catch(() => {
								if (!il.BrowserNotifications.isGranted()) {
									showErrorMessage($container, 'osc_browser_noti_req_permission_error');
									deselectAndLockCheckbox($notificationToggle);
								}
							});
						}
					});
				}
			});
		});
	})(jQuery, window);
</script>
